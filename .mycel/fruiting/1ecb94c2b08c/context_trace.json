{
  "session_id": "1ecb94c2b08c",
  "task_id": "fba91c29-0efb-487a-9b1b-e086350c9d71",
  "agent": "claude",
  "model": "sonnet",
  "repo_path": "/home/mkagent/repos/terror-in-the-jungle",
  "timestamp": "2026-01-24T21:22:19.930523",
  "layers": [
    {
      "name": "prompt",
      "content": "## Context\nYou are working on Terror in the Jungle, a 3D pixel art battlefield game with Three.js. The game supports 15v15 in Zone Control and 60v60 in Open Frontier mode. NPC performance is a critical issue - enemies tank FPS when clustered, especially during large battles.\n\n## Your Task\nImplement an octree-based spatial partitioning system to optimize NPC queries and collision detection, replacing or enhancing the current SpatialGrid.\n\n## Discovery Phase\nRead these files to understand the current system:\n1. `src/systems/combat/SpatialGrid.ts` - current 2D grid-based spatial partitioning\n2. `src/systems/combat/CombatantSystem.ts` - main combat orchestrator, see update loop\n3. `src/systems/combat/CombatantAI.ts` - AI uses findNearestEnemy with spatial queries\n4. `src/systems/combat/CombatantCombat.ts` - combat queries for hit detection\n5. `CLAUDE.md` - see NPC Performance Crisis section\n\n## Current Problems\n1. SpatialGrid is 2D only - doesn't account for terrain height differences\n2. Queries iterate all entities in cell - O(n) per cell\n3. No frustum culling for AI updates\n4. Hit detection scans all combatants\n\n## Requirements\n\n### Octree Implementation\n1. Create `SpatialOctree.ts` with:\n   - Node capacity of 8-16 entities before subdivision\n   - Max depth of 6 levels\n   - Efficient insert/remove/query operations\n   - Frustum query support for camera-based culling\n\n### Query Optimizations\n1. `queryRadius(center, radius)` - return entities within sphere\n2. `queryFrustum(frustum)` - return entities visible to camera\n3. `queryRay(origin, direction, maxDist)` - return entities along ray\n4. `queryNearestK(center, k, maxDist)` - return k nearest entities\n\n### Integration\n1. Replace or wrap SpatialGrid with new octree\n2. Update CombatantSystem to use frustum culling for LOD assignment\n3. Update CombatantAI.findNearestEnemy to use optimized queries\n4. Update CombatantCombat for efficient hit detection\n\n### Performance Targets\n- Support 120+ active NPCs at 60 FPS\n- Query time under 0.5ms for radius queries\n- Rebuild time under 2ms when positions change\n\n## Technical Constraints\n- File should be under 400 lines\n- Use TypeScript strict mode\n- Minimize allocations in hot paths (reuse Vector3)\n- Must be backward compatible with SpatialGrid interface\n\n## Implementation Steps\n1. Design octree node structure with bounds\n2. Implement insert/remove with automatic subdivision\n3. Implement query methods with early termination\n4. Add frustum culling support\n5. Integrate with CombatantSystem\n6. Profile and optimize\n\n## Validation\n- Run `npm run build` to verify no type errors\n- Test in browser with Zone Control (15v15) - should maintain 60 FPS\n- Test in browser with Open Frontier (60v60) - should maintain 30+ FPS\n- Use F1 to check performance metrics\n\n## Completion\nWhen complete:\n1. Build and test in both game modes\n2. Commit with message: \"perf(combat): add octree spatial partitioning for NPC scalability\"\n3. Provide performance comparison (before/after FPS if measurable)",
      "source": "task.prompt"
    },
    {
      "name": "output_format",
      "content": "Required output format: <task_result> block with commit, pr_url, branch, summary",
      "source": "generated"
    }
  ]
}