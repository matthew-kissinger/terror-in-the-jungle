{
  "session_id": "94b77a51b01c",
  "task_id": "dbcb4400-0d07-4394-a62f-1f3e5844fd11",
  "agent": "claude",
  "model": "sonnet",
  "repo_path": "/home/mkagent/repos/terror-in-the-jungle",
  "timestamp": "2026-01-24T18:36:38.654425",
  "layers": [
    {
      "name": "prompt",
      "content": "# Task: Add Cover-Seeking Behavior to Combat AI\n\nYou are working on terror-in-the-jungle, a 3D pixel art battlefield game built with Three.js. The combat AI needs improvement - NPCs feel predictable and don't seek cover when under fire.\n\n## Context\nThe game has a CombatantAI system at src/systems/combat/CombatantAI.ts that handles NPC behavior through state machines (PATROLLING, ALERT, ENGAGING, SUPPRESSING). Currently, NPCs engage targets directly without seeking cover, making combat feel less tactical.\n\n## Discovery - Read These Files First\n1. src/systems/combat/CombatantAI.ts - Current AI state machine\n2. src/systems/combat/types.ts - Combatant types and states\n3. src/systems/combat/CombatantMovement.ts - Movement system\n4. src/systems/weapons/SandbagSystem.ts - Player-placed cover (sandbags)\n5. CLAUDE.md - Project guidelines and priorities\n\n## Implementation Requirements\n\n### 1. Add SEEKING_COVER State\nAdd a new state to the CombatantState enum in types.ts:\n- SEEKING_COVER - active when combatant is moving to cover\n\n### 2. Cover Detection Logic\nIn CombatantAI.ts, add methods to:\n- Find nearby terrain features that could serve as cover (terrain height differences > 1m)\n- Check if a position provides cover from a threat direction\n- Use the existing chunkManager for terrain height queries\n\n### 3. Trigger Conditions\nCombatants should seek cover when:\n- Taking damage (lastHitTime within 2 seconds)\n- Health below 50%\n- Under suppressing fire (multiple shots in quick succession)\n\n### 4. Cover Behavior\n- When triggered, set destinationPoint to nearest valid cover position\n- Once in cover, return to ENGAGING state but with reduced exposure (peek and shoot)\n- Add a cooldown before seeking new cover (3-5 seconds)\n\n### Design Constraints\n- Keep performance in mind - don't compute cover positions every frame\n- Only high/medium LOD combatants should seek cover (check lodLevel)\n- Maximum cover search radius: 30 units\n- Reuse existing movement system (destinationPoint) for pathfinding\n\n## Validation\n1. Run `npm run dev` and observe NPCs in combat\n2. NPCs should move to terrain high points when damaged\n3. Check console for any new errors\n4. Run `npm run build` to ensure no type errors\n\n## Completion\nWhen done:\n1. Test in browser - NPCs should visibly seek cover when damaged\n2. Commit with message: \"feat(ai): add cover-seeking behavior when under fire\"\n3. Provide summary of changes and observed behavior",
      "source": "task.prompt"
    },
    {
      "name": "output_format",
      "content": "Required output format: <task_result> block with commit, pr_url, branch, summary",
      "source": "generated"
    }
  ]
}