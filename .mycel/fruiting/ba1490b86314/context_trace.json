{
  "session_id": "ba1490b86314",
  "task_id": "7bf19b57-e23d-4855-a89b-c8df0645544b",
  "agent": "claude",
  "model": "sonnet",
  "repo_path": "/home/mkagent/repos/terror-in-the-jungle",
  "timestamp": "2026-01-24T18:00:21.714948",
  "layers": [
    {
      "name": "prompt",
      "content": "# Add Grenade Cooking Mechanic\n\n## Context\nYou are working on terror-in-the-jungle, a 3D pixel art FPS game built with Three.js. The grenade system exists but per CLAUDE.md needs improvement: 'Grenade System Overhaul - No cooking mechanic - add hold-to-cook'.\n\nCooking means holding the grenade after pulling the pin, letting the fuse burn down before throwing. This is a tactical feature that lets skilled players time air-bursts for maximum effect.\n\n## Discovery\nRead these files first:\n1. src/systems/weapons/GrenadeSystem.ts - The existing grenade system (primary file to modify)\n2. src/systems/player/InventoryManager.ts - Inventory management\n3. src/ui/hud/HUDSystem.ts - For displaying cook time\n4. src/ui/hud/HUDElements.ts - HUD element patterns\n5. src/systems/player/PlayerController.ts - Input handling patterns\n\n## Current Behavior\n- Press G to start aiming (shows arc preview)\n- Power builds up over time while aiming\n- Release to throw\n- Grenade has FUSE_TIME of 3.5 seconds after throw\n\n## New Behavior: Cooking\n1. Press G to pull pin and start cooking (grenade fuse starts immediately)\n2. While holding G:\n   - Show cook timer on HUD (seconds remaining)\n   - Arc preview shows where grenade will land\n   - Power can optionally still build (or use fixed power)\n3. Release G to throw with remaining fuse time\n4. If fuse expires while holding, grenade explodes in hand (self-damage)\n\n## Implementation Details\n\n### GrenadeSystem Changes\n- Add `isCooking: boolean` state\n- Add `cookTime: number` tracking elapsed cook time\n- Modify `startAiming()` to also start cooking\n- Modify `update()` to track cook time while aiming\n- If cookTime >= FUSE_TIME while aiming, explode in player's hand\n- On throw, grenade's remaining fuse = FUSE_TIME - cookTime\n- Add `getCookProgress(): number` (0-1) for HUD\n\n### HUD Indicator\n- Show circular timer or progress bar when cooking\n- Red warning when fuse is almost out (< 1 second)\n- Position near crosshair or in corner\n\n### Self-Damage\nIf grenade cooks too long:\n- Apply explosion damage to player via PlayerHealthSystem\n- Visual feedback (screen shake, damage flash)\n- Don't let player throw a cooked grenade\n\n### UX Considerations\n- Clear audio/visual cue when cooking starts (pin pull sound)\n- Ticking sound effect that speeds up as fuse runs low\n- Allow canceling cook with right-click (discards grenade? or just cancels without penalty for balance?)\n\n## Testing\n1. Run `npm run dev`\n2. Pick up grenades and test:\n   - Tap G quickly - grenade should have nearly full fuse\n   - Hold G for 2 seconds - grenade should have ~1.5s fuse remaining\n   - Hold G for 3.5+ seconds - should explode in hand\n   - Verify HUD shows cook timer\n   - Verify arc preview still works while cooking\n\n## Completion\nWhen complete:\n1. Test thoroughly in browser\n2. Commit with message: \"feat: add grenade cooking mechanic with HUD timer\"\n3. Provide summary of implementation",
      "source": "task.prompt"
    },
    {
      "name": "output_format",
      "content": "Required output format: <task_result> block with commit, pr_url, branch, summary",
      "source": "generated"
    }
  ]
}