{
  "session_id": "209dda4dd8d6",
  "task_id": "8003cc18-14d5-433b-937f-c182e731abd3",
  "agent": "claude",
  "model": "sonnet",
  "repo_path": "/home/mkagent/repos/terror-in-the-jungle",
  "timestamp": "2026-01-24T22:22:48.604316",
  "layers": [
    {
      "name": "prompt",
      "content": "# Memory Pooling for Allocation-Free Combat Loop\n\n## Context\nYou are working on Terror in the Jungle, a 3D pixel art battlefield game with 15v15 to 60v60 combat. The combat system allocates Vector3/Quaternion objects in hot loops, causing GC pauses that create frame stutters. This task eliminates allocations in critical paths.\n\n## Objective\nCreate shared object pools for Vector3, Quaternion, and raycast containers, then refactor hot paths in combat, movement, and rendering to reuse pooled objects instead of allocating new ones.\n\n## Discovery - Read These Files First\n1. `CLAUDE.md` - Project overview\n2. `src/systems/combat/CombatantMovement.ts` - Movement calculations (hot path)\n3. `src/systems/combat/CombatantAI.ts` - AI decision making with LOS checks\n4. `src/systems/combat/CombatantRenderer.ts` - Billboard rendering updates\n5. `src/systems/combat/CombatantCombat.ts` - Combat calculations\n6. `src/utils/` - Existing utility modules\n\n## Implementation Steps\n\n### Step 1: Create ObjectPoolManager\nCreate `src/utils/ObjectPoolManager.ts`:\n```typescript\n// Singleton for shared object pools\nclass ObjectPoolManager {\n  private vector3Pool: Vector3[] = []\n  private quaternionPool: Quaternion[] = []\n  private raycasterPool: Raycaster[] = []\n  \n  // Get methods return from pool or create new\n  getVector3(): Vector3\n  getQuaternion(): Quaternion\n  getRaycaster(): Raycaster\n  \n  // Release methods return to pool\n  releaseVector3(v: Vector3): void\n  releaseQuaternion(q: Quaternion): void\n  releaseRaycaster(r: Raycaster): void\n  \n  // Pre-allocate pools at startup\n  warmup(vector3Count: number, quaternionCount: number, raycasterCount: number): void\n}\n```\nPre-allocate: 50 Vector3, 20 Quaternion, 10 Raycaster at init.\n\n### Step 2: Refactor CombatantMovement\nFind and eliminate allocations in `updateMovement()`:\n- Replace `new Vector3()` with pool.getVector3()\n- Release vectors at end of update cycle\n- Common pattern:\n  ```typescript\n  const dir = pool.getVector3()\n  dir.copy(target).sub(position).normalize()\n  // use dir...\n  pool.releaseVector3(dir)\n  ```\n\n### Step 3: Refactor CombatantAI LOS Checks\nVision and line-of-sight checks allocate raycasters:\n- Reuse single raycaster per AI update cycle\n- Pre-allocate intersection result arrays\n- Clear arrays instead of creating new ones\n\n### Step 4: Refactor CombatantRenderer\nBillboard matrix updates may allocate:\n- Check for matrix allocations in update loops\n- Pre-allocate transformation matrices\n- Reuse matrix objects across frames\n\n### Step 5: Add Allocation Telemetry\nCreate debug mode to track allocations:\n- Count pool borrows per frame\n- Track peak pool usage\n- Warn if pool exhausted (fallback to new allocation)\n- Display in F1 debug overlay\n\n## Validation\n- [ ] ObjectPoolManager created with warmup functionality\n- [ ] CombatantMovement uses pooled vectors (grep for 'new Vector3' should find none in hot paths)\n- [ ] CombatantAI reuses raycasters for LOS checks\n- [ ] Frame pacing improved (check with performance profiler)\n- [ ] Telemetry shows pool utilization\n\n## Technical Constraints\n- Pools must be thread-safe (single-threaded JS but async callbacks)\n- Always release objects in finally blocks to prevent leaks\n- Keep ObjectPoolManager under 150 lines\n- Document pool size tuning in comments\n\n## Performance Target\n- Reduce per-frame allocations by 80%\n- Eliminate GC pauses > 2ms during combat\n- Maintain 60fps with 30+ active NPCs\n\n## Completion\nWhen complete:\n1. Test in browser with `npm run dev`\n2. Open DevTools Performance tab and record 30 seconds of Zone Control combat\n3. Verify reduced GC activity in timeline\n4. Commit with descriptive message: 'perf(combat): add memory pooling for allocation-free combat loop'\n5. Provide summary with before/after allocation counts if measurable",
      "source": "task.prompt"
    },
    {
      "name": "output_format",
      "content": "Required output format: <task_result> block with commit, pr_url, branch, summary",
      "source": "generated"
    }
  ]
}