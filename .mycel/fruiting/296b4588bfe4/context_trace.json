{
  "session_id": "296b4588bfe4",
  "task_id": "1bb39481-807f-4848-a325-672754ec884e",
  "agent": "claude",
  "model": "sonnet",
  "repo_path": "/home/mkagent/repos/terror-in-the-jungle",
  "timestamp": "2026-01-24T21:22:19.901504",
  "layers": [
    {
      "name": "prompt",
      "content": "## Context\nYou are working on Terror in the Jungle, a 3D pixel art battlefield game built with Three.js. The mortar system was previously implemented but had to be disabled due to issues with camera switching, projectile physics, and visual rendering.\n\n## Your Task\nReimplement the mortar system from scratch with proper ballistic physics, trajectory preview, and polished visuals.\n\n## Discovery Phase\nRead these files first to understand the context:\n1. `src/systems/weapons/MortarSystem.ts` - current disabled stub\n2. `src/systems/weapons/GrenadeSystem.ts` - reference for projectile physics and explosion effects\n3. `src/systems/player/InventoryManager.ts` - weapon slot system (mortar uses slot 4)\n4. `src/systems/player/FirstPersonWeapon.ts` - reference for weapon switching\n5. `src/core/SandboxSystemManager.ts` - system initialization and connections\n\n## Requirements\n\n### Core Mechanics\n1. **Deployment**: Player deploys mortar tube at current position (press 4 to select slot, E to deploy)\n2. **Aiming**: Mouse controls pitch (vertical angle 45-85 degrees) and yaw (horizontal)\n3. **Trajectory Preview**: Show arc line from tube to predicted landing point with landing indicator\n4. **Firing**: Click to launch mortar round along ballistic arc\n5. **Ballistics**: Realistic parabolic trajectory with gravity (9.8 m/s^2), initial velocity ~50-80 m/s\n\n### Visual Elements\n1. **Mortar Tube**: 3D procedural model (use ProgrammaticExplosivesFactory.ts as base)\n2. **Mortar Round**: Visible projectile during flight\n3. **Trajectory Arc**: Dashed line showing predicted path\n4. **Landing Indicator**: Circle on ground showing impact point\n5. **Explosion**: Reuse ExplosionEffectsPool for impact\n\n### Integration Points\n1. Connect to InventoryManager for slot switching\n2. Use CombatantSystem.handleExplosion() for damage\n3. Use ImpactEffectsPool for visual effects\n4. Keep main camera - do NOT create a separate weapon camera\n\n### Technical Constraints\n- Keep file under 400 lines (split into modules if needed)\n- Use existing effect pools - do not create new ones\n- Follow GameSystem interface pattern\n- Use ChunkManager.getHeightAt() for terrain collision\n\n## Implementation Steps\n1. Create MortarBallistics.ts module for physics calculations\n2. Create MortarVisuals.ts module for trajectory preview and landing indicator\n3. Refactor MortarSystem.ts as orchestrator\n4. Wire up input handling (deploy/undeploy/aim/fire)\n5. Integrate with existing systems\n\n## Validation\n- Test that mortar deploys and fires\n- Verify trajectory preview updates in real-time with mouse movement\n- Confirm rounds land at predicted location\n- Check that explosions deal damage to combatants\n\n## Completion\nWhen complete:\n1. Build and test: `npm run build && npm run dev`\n2. Verify in browser - deploy mortar (4, E), aim, fire\n3. Commit with message: \"feat(weapons): reimplement mortar system with ballistic physics\"\n4. Provide summary of implementation",
      "source": "task.prompt"
    },
    {
      "name": "output_format",
      "content": "Required output format: <task_result> block with commit, pr_url, branch, summary",
      "source": "generated"
    }
  ]
}